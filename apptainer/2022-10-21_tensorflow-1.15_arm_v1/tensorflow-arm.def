Bootstrap: library
From: ubuntu-arm64:18.04
Stage: tensorflow

%post
    echo "deb http://ports.ubuntu.com/ubuntu-ports/ bionic universe" >> /etc/apt/sources.list
    apt update -y
    apt upgrade -y

    apt install -y gcc g++ make liblapack-dev python2.7 python2.7-dev python-numpy pkg-config git wget python3 python3-dev python3-pip python3-numpy swig python3-dev openjdk-8-jdk openjdk-11-jdk pkg-config zip zlib1g-dev unzip autoconf automake libtool

    mkdir /opt/builds/
    cd /opt/builds/
    wget https://github.com/bazelbuild/bazel/releases/download/0.26.1/bazel-0.26.1-dist.zip
    unzip -d bazel-0.26.1 bazel-0.26.1-dist.zip
    cd bazel-0.26.1
    export JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk-arm64
    env EXTRA_BAZEL_ARGS="--host_javabase=@local_jdk//:jdk" bash ./compile.sh
    cp /opt/builds/bazel-0.26.1/output/bazel /usr/bin/bazel
    chmod +x /usr/bin/bazel

    mkdir -p /opt/tensorflow/
    cd /opt/tensorflow/

    wget https://github.com/tensorflow/tensorflow/archive/v1.15.2.tar.gz
    tar xzvf v1.15.2.tar.gz
    mv tensorflow-1.15.2 tensorflow

    cat << EOF > /opt/tensorflow/tensorflow/.tf_configure.bazelrc
build --host_force_python=PY3
build --action_env PYTHON_BIN_PATH="/usr/bin/python3"
build --action_env PYTHON_LIB_PATH="/usr/local/lib/python3.6/dist-packages"
build --python_path="/usr/bin/python3"
build:xla --define with_xla_support=true
build --config=xla
build --action_env LD_LIBRARY_PATH="/.singularity.d/libs"
build --action_env GCC_HOST_COMPILER_PATH="/usr/bin/gcc"
build:opt --copt=-march=native
build:opt --copt=-Wno-sign-compare
build:opt --host_copt=-march=native
build:opt --define with_default_optimizations=true
build:v2 --define=tf_api_version=2
test --flaky_test_attempts=3
test --test_size_filters=small,medium
test --test_tag_filters=-benchmark-test,-no_oss,-oss_serial
test --build_tag_filters=-benchmark-test,-no_oss
test --test_tag_filters=-gpu
test --build_tag_filters=-gpu
build --action_env TF_CONFIGURE_IOS="0"
EOF

    mkdir -p /opt/tensorflow/bazel_out/
    cd /opt/tensorflow/tensorflow
    bazel --output_base=/opt/tensorflow/bazel_out build --define framework_shared_object=true --config=opt --config=noaws --config=nogcp --config=noignite --config=nokafka //tensorflow:libtensorflow_cc.so //tensorflow:libtensorflow.so
