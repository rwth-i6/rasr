Bootstrap: docker
From: tensorflow/tensorflow:2.13.0-gpu 
Stage: build

%post
    apt update -y

    # all the fundamental basics, zsh is need because calling the cache manager might launch the user shell
    DEBIAN_FRONTEND=noninteractive apt install -y wget git unzip gzip libssl-dev lsb-release zsh \
        bison libxml2-dev libopenblas-dev libsndfile1-dev libcrypto++-dev libcppunit-dev \
        parallel xmlstarlet python3-lxml htop strace gdb sox python3-pip cmake ffmpeg vim

    # download the cache manager and place in /usr/local
    cd /usr/local
    git clone https://github.com/rwth-i6/cache-manager.git
    cd bin
    ln -s ../cache-manager/cf cf

    apt install -y python3 python3-pip

    # general
    pip3 install -U pip setuptools wheel

    # Returnn
    pip3 install h5py six soundfile librosa==0.10 better-exchook

    # Sisyphus
    pip3 install psutil flask ipython
    pip3 install git+https://github.com/rwth-i6/sisyphus

    # i6_core / i6_experiments
    pip3 install black==22.3.0 matplotlib sequitur-g2p==1.0.1668.23 typing-extensions typeguard

    pip3 install tree
    pip3 install dm-tree

%environment
    # Location of libtensorflow_cc.so and libtensorflow_framework.so
    export LD_LIBRARY_PATH=/usr/local/lib/tensorflow/:$LD_LIBRARY_PATH

